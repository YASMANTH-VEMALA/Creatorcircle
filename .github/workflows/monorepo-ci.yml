name: Monorepo CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'

jobs:
  monorepo-health:
    name: Monorepo Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: üèóÔ∏è Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: üì¶ Install all dependencies
      run: npm ci
    
    - name: üèóÔ∏è Build all shared packages
      run: |
        npm run build --workspaces --if-present
    
    - name: üß™ Test all packages
      run: |
        npm run test --workspaces --if-present
    
    - name: üßπ Lint all code
      run: |
        npm run lint --workspaces --if-present
    
    - name: ‚úÖ Verify monorepo structure
      run: |
        echo "üìã Checking monorepo structure..."
        npm list --workspaces --depth=0
        echo ""
        echo "üì± Mobile app files:"
        ls -la apps/mobile/ | head -10
        echo ""
        echo "üñ•Ô∏è Backend placeholder:"
        ls -la apps/backend/
        echo ""
        echo "üìö Shared packages:"
        ls -la packages/
        echo ""
        echo "‚úÖ Monorepo structure healthy!"
    
    - name: üîç Check for potential issues
      run: |
        echo "üîç Checking for common monorepo issues..."
        
        # Check for duplicate dependencies
        echo "üì¶ Checking for duplicate dependencies..."
        npm ls --all 2>&1 | grep -i "duplicate\|conflict" || echo "No duplicate dependencies found"
        
        # Check workspace configuration
        echo "‚öôÔ∏è Checking workspace configuration..."
        npm config list | grep workspace || echo "Workspace config OK"
        
        echo "‚úÖ No critical issues detected"
